// ==========================================
// â˜… è¨­å®šé …ç›®ï¼ˆã“ã“ã ã‘æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰
// ==========================================

// ã‚ãªãŸãŒç™ºè¡Œã—ãŸæœ€æ–°ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL
const AUTH_URL = "https://script.google.com/macros/s/AKfycbyT7jve6SrEX6WFA6rjNBJnJDZyoLldA3CHnTzzymiApEi2Sgr-W4siJjzBPuNYB6gMrA/exec";

// ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåï¼ˆIDè¿½åŠ æ™‚ã«è¨­å®šã—ãŸåå‰ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
const LIB = TaskManager; 

// ==========================================
// 1. èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆ7æ—¥é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç‰ˆï¼‰
// ==========================================
function isAuthorized() {
  const userProperties = PropertiesService.getUserProperties();
  const cachedStatus = userProperties.getProperty('AUTH_CACHE');
  const lastChecked = userProperties.getProperty('AUTH_DATE');
  const now = new Date().getTime();
  const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000; 

  if (cachedStatus === 'OK' && lastChecked && (now - lastChecked < ONE_WEEK_MS)) {
    return true;
  }

  const userEmail = Session.getActiveUser().getEmail();
  try {
    const response = UrlFetchApp.fetch(AUTH_URL + "?email=" + userEmail);
    if (response.getContentText() === "OK") {
      userProperties.setProperty('AUTH_CACHE', 'OK');
      userProperties.setProperty('AUTH_DATE', now.toString());
      return true;
    } else {
      userProperties.deleteProperty('AUTH_CACHE');
      userProperties.deleteProperty('AUTH_DATE');
      return false;
    }
  } catch (e) {
    return false;
  }
}

function authError() {
  Browser.msgBox("ã‚¨ãƒ©ãƒ¼: ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
}

// ==========================================
// 2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹ç¯‰ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼
// ==========================================
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ“… ã‚¿ã‚¹ã‚¯é€£æº')
    .addItem('ğŸ”§ è¨­å®šãƒã‚§ãƒƒã‚¯ (è¨ºæ–­)', 'checkConfiguration')
    .addSeparator()
    .addItem('ğŸ”§ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®å¾© (ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å†è¨­ç½®)', 'repairCheckboxes')
    .addSeparator()
    .addItem('è¨­å®š: è‡ªå‹•åŒ–ãƒˆãƒªã‚¬ãƒ¼ã‚’ã‚»ãƒƒãƒˆ (æ›´æ–°æ™‚ã‚‚å®Ÿè¡Œ)', 'setupTriggers')
    .addSeparator()
    .addItem('æ‰‹å‹•: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚·ãƒ¼ãƒˆä½œæˆ', 'createProjectSheets')
    .addItem('æ‰‹å‹•: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ (ã‚¿ã‚¹ã‚¯å…¥åŠ› -> Cal)', 'syncTasksToCalendar')
    .addItem('æ‰‹å‹•: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ (Cal -> ã‚·ãƒ¼ãƒˆ)', 'syncFromCalendarToSheets')
    .addItem('æ‰‹å‹•: ã€çµ±åˆã€‘åŒæœŸãƒ»è»¢é€ãƒ»ä¸¦ã³æ›¿ãˆ', 'executeTasksAction')
    .addItem('æ‰‹å‹•: ã‚¿ã‚¹ã‚¯ä¸€è¦§æ›´æ–° (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰)', 'updateDashboard')
    .addSeparator()
    .addItem('åˆ†æ: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (é›†è¨ˆ)', 'aggregateAndVisualize')
    .addToUi();
}

// ç·¨é›†æ™‚ã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆèªè¨¼ã‚’é€šã—ã¦ã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ï¼‰
function onEditTrigger(e) {
  if (!isAuthorized()) return; 
  LIB.onEditTrigger(e);
}

// ==========================================
// 3. æ©Ÿèƒ½å‘¼ã³å‡ºã—ï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ï¼‰
// ==========================================

// --- è¨­å®šãƒ»è¨ºæ–­ ---
function checkConfiguration() {
  if (isAuthorized()) LIB.checkConfiguration(); else authError();
}

function setupTriggers() {
  if (isAuthorized()) LIB.setupTriggers(); else authError();
}

function repairCheckboxes() {
  if (isAuthorized()) LIB.repairCheckboxes(); else authError();
}

// --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† ---
function createProjectSheets() {
  if (isAuthorized()) LIB.createProjectSheets(); else authError();
}

// --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸãƒ»ã‚¿ã‚¹ã‚¯æ“ä½œ ---
function syncTasksToCalendar() {
  if (isAuthorized()) LIB.syncTasksToCalendar(); else authError();
}

function syncFromCalendarToSheets() {
  if (isAuthorized()) LIB.syncFromCalendarToSheets(); else authError();
}

function executeTasksAction() {
  if (isAuthorized()) LIB.executeTasksAction(); else authError();
}

// --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»åˆ†æ ---
function updateDashboard() {
  if (isAuthorized()) LIB.updateDashboard(); else authError();
}

function aggregateAndVisualize() {
  if (isAuthorized()) LIB.aggregateAndVisualize(); else authError();
}